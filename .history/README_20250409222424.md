# Sandbox Environment for Open Interpreter

这是一个为 Open Interpreter 设计的代码执行沙箱环境，提供安全的代码执行隔离和资源监控功能。

## 功能特点

- 安全的代码执行环境
- 资源使用限制（内存、CPU、执行时间）
- 文件系统和网络访问控制
- 模块导入权限管理
- 支持同步和异步执行
- 与 Open Interpreter 无缝集成
- 可配置的安全策略

## 安装步骤

1. 克隆项目：
```bash
git clone https://github.com/your-username/sandbox-environment.git
cd sandbox-environment
```

2. 创建虚拟环境（推荐）：
```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python -m venv venv
source venv/bin/activate
```

3. 安装依赖：
```bash
pip install -r requirements.txt
```

4. 安装开发版本：
```bash
pip install -e .
```

## 基本使用

### 1. 简单示例

```python
from sandbox.integration.interpreter import InterpreterSandbox

# 创建沙箱实例
sandbox = InterpreterSandbox()

# 执行代码
result = sandbox.run("""
x = 1 + 1
__result__ = x
""")
print(f"计算结果: {result}")  # 输出: 2
```

### 2. 自定义配置

```python
from sandbox.config.settings import SandboxSettings

# 创建自定义配置
settings = SandboxSettings(
    max_memory_mb=100,      # 内存限制：100MB
    max_cpu_percent=50,     # CPU限制：50%
    max_execution_time=5,   # 执行时间限制：5秒
    allowed_directories=["./"],  # 允许访问的目录
    network_access=False,   # 禁止网络访问
    allow_file_operations=False,  # 禁止文件操作
    allow_imports=True,     # 允许导入模块
    allowed_modules=['math', 'random', 'json']  # 允许导入的模块
)

# 更新配置
sandbox.update_settings(settings)
```

### 3. 异步执行

```python
import asyncio
from sandbox.integration.interpreter import InterpreterSandbox

async def main():
    sandbox = InterpreterSandbox()
    result = await sandbox.run_async("""
import time
time.sleep(1)  # 模拟耗时操作
__result__ = "异步执行完成"
""")
    print(result)

asyncio.run(main())
```

### 4. 与 Open Interpreter 集成

```python
from interpreter import interpreter
from sandbox.integration.interpreter import InterpreterSandbox

# 创建沙箱实例
sandbox = InterpreterSandbox()

# 配置 Open Interpreter 使用沙箱
interpreter.sandbox = sandbox

# 使用 Open Interpreter 执行代码
interpreter.chat("计算1到100的和")
```

## 配置选项

### SandboxSettings 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| max_memory_mb | int | 100 | 内存使用上限（MB） |
| max_cpu_percent | int | 50 | CPU使用率上限（%） |
| max_execution_time | int | 5 | 最大执行时间（秒） |
| allowed_directories | list | ["./"] | 允许访问的目录列表 |
| network_access | bool | False | 是否允许网络访问 |
| allow_file_operations | bool | False | 是否允许文件操作 |
| allow_imports | bool | True | 是否允许导入模块 |
| allowed_modules | list | ['math', 'random', 'json'] | 允许导入的模块列表 |
| check_interval | float | 0.1 | 资源检查间隔（秒） |
| verbose | bool | True | 是否显示详细日志 |

## 错误处理

```python
from sandbox.core.sandbox import SandboxError, ResourceLimitExceeded

try:
    result = sandbox.run("""
import array
arr = array.array('i', [0] * 10000000)
__result__ = len(arr)
""")
except ResourceLimitExceeded as e:
    print(f"资源超出限制: {e}")
except SandboxError as e:
    print(f"沙箱错误: {e}")
except Exception as e:
    print(f"其他错误: {e}")
```

## 运行测试

```bash
# 运行所有测试
python -m pytest tests/

# 运行特定测试
python -m pytest tests/test_sandbox.py -v

# 运行示例
python examples/basic_usage.py
python examples/async_usage.py
python examples/interpreter_integration.py
```

## 注意事项

1. 始终在虚拟环境中运行代码
2. 仔细配置资源限制，避免系统过载
3. 定期检查日志，监控资源使用情况
4. 在正式环境中使用前，先在测试环境验证配置
5. 根据实际需求调整权限设置
6. 注意错误处理和异常捕获

## 故障排除

如果遇到问题，请检查：

1. 日志输出
2. 配置是否正确
3. 权限设置是否合适
4. 资源限制是否合理
5. 测试用例是否通过

## 性能优化建议

1. 适当调整 `check_interval` 参数
2. 合理设置资源限制
3. 使用异步执行处理耗时操作
4. 定期清理不需要的资源
5. 监控系统资源使用情况

## 贡献指南

欢迎提交 Issue 和 Pull Request 来帮助改进项目。

## 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。
